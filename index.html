<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MX-5 NA — Headlight Controller</title>

  <!-- ============================================================
       FONTS
       Bebas Neue  → large display headings
       Share Tech Mono → monospace status labels / values
       Rajdhani    → general UI text and buttons
  ============================================================ -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&display=swap');

    /* ============================================================
       DESIGN TOKENS — edit these to retheme the entire UI
    ============================================================ */
    :root {
      --bg:         #0a0a0c;          /* page background */
      --panel:      #111116;          /* card / panel background */
      --border:     #1e1e2a;          /* subtle borders */
      --amber:      #cc1010;          /* primary accent (red-amber) */
      --amber-glow: rgba(204,16,16,0.15);
      --red:        #ff3c3c;          /* error / disconnect */
      --green:      #39ff6a;          /* connected / active */
      --blue:       #00c8ff;          /* connect button */
      --text:       #c8c8d8;          /* body text */
      --muted:      #555570;          /* secondary / dimmed text */
    }

    /* ============================================================
       RESET
    ============================================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ============================================================
       BODY — centred flex column, dark background
    ============================================================ */
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-x: hidden;
    }

    /* CRT scanline overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.08) 2px,
        rgba(0,0,0,0.08) 4px
      );
      pointer-events: none;
      z-index: 999;
    }

    /* Subtle film-grain noise overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 998;
      opacity: 0.4;
    }

    /* ============================================================
       BLUETOOTH / SERIAL STATUS BAR
    ============================================================ */
    .bt-bar {
      width: 100%;
      max-width: 860px;
      margin-bottom: 14px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    /* Coloured dot indicating connection state */
    .bt-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      flex-shrink: 0;
      transition: all 0.3s;
    }
    .bt-status-dot.connecting { background: var(--amber); box-shadow: 0 0 8px var(--amber); animation: pulse 1s infinite; }
    .bt-status-dot.connected  { background: var(--green);  box-shadow: 0 0 8px var(--green); }
    .bt-status-dot.error      { background: var(--red);    box-shadow: 0 0 8px var(--red); }

    /* Text label next to the dot */
    .bt-status-text {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--muted);
      flex: 1;
    }
    .bt-status-text.connected { color: var(--green); }
    .bt-status-text.error     { color: var(--red); }

    /* Connect / Disconnect buttons */
    .bt-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 6px 14px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .bt-btn.connect    { border-color: var(--blue); color: var(--blue); }
    .bt-btn.connect:hover    { background: rgba(0,200,255,0.08); box-shadow: 0 0 12px rgba(0,200,255,0.2); }
    .bt-btn.disconnect { border-color: var(--red); color: var(--red); }
    .bt-btn.disconnect:hover { background: rgba(255,60,60,0.08); }

    /* Device name shown when connected */
    .bt-device-name {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--amber);
      letter-spacing: 1px;
    }

    /* TX activity indicator flashes blue when data is sent */
    .bt-tx {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: #333;
      transition: color 0.1s;
    }
    .bt-tx.flash { color: var(--blue); }

    /* Warning banner shown when Web Serial API is unavailable */
    .no-bt-warn {
      background: rgba(255,60,60,0.06);
      border: 1px solid rgba(255,60,60,0.2);
      border-radius: 3px;
      padding: 8px 14px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: rgba(255,60,60,0.7);
      letter-spacing: 1px;
      margin-bottom: 10px;
      display: none;             /* shown by JS if needed */
      width: 100%;
      max-width: 860px;
    }

    /* ============================================================
       PAGE HEADER
    ============================================================ */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 4px;
    }

    /* Decorative horizontal lines flanking the title */
    .logo-line       { width: 60px; height: 1px; background: linear-gradient(90deg, transparent, var(--amber)); }
    .logo-line.right { background: linear-gradient(90deg, var(--amber), transparent); }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(28px, 6vw, 52px);
      letter-spacing: 8px;
      color: var(--amber);
      text-shadow: 0 0 30px var(--amber-glow), 0 0 60px rgba(255,184,0,0.1);
    }

    .subtitle {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 4px;
      text-transform: uppercase;
    }

    /* ============================================================
       MAIN LAYOUT
    ============================================================ */
    .main-container {
      width: 100%;
      max-width: 860px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    /* ============================================================
       CAR VISUALISATION PANEL
    ============================================================ */
    .car-viz {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 28px 20px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* "LIVE PREVIEW" label in top-right corner */
    .car-viz::before {
      content: 'LIVE PREVIEW';
      position: absolute;
      top: 10px;
      right: 14px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--muted);
    }

    /* Wrapper for both headlights, sized to match the car SVG width */
    .car-front {
      position: relative;
      width: 320px;
      height: 160px;
    }

    /* ---- Headlight element ---- */
    .headlight {
      position: absolute;
      width: 72px;
      height: 48px;
      border: 2px solid #222;
      border-radius: 6px 6px 2px 2px;
      overflow: hidden;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .headlight.left  { left: 28px;  top: 40px; }
    .headlight.right { right: 28px; top: 40px; }

    /* Dark casing behind the lens */
    .headlight-body {
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #1a1a1a 0%, #111 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: background 0.3s;
    }

    /* Lens / bulb element */
    .headlight-inner {
      width: 44px;
      height: 28px;
      border-radius: 4px 4px 1px 1px;
      background: #0d0d0d;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }

    /* Glare reflection on the lens */
    .headlight-lens {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 30%, rgba(255,200,80,0) 0%, rgba(255,150,0,0) 100%);
      border-radius: 4px 4px 1px 1px;
      transition: background 1s;
    }

    /* Lit state: amber glow on inner lens and body */
    .headlight.on .headlight-inner {
      background: #ffcc44;
      box-shadow: 0 0 20px rgba(255,200,60,0.9), 0 0 40px rgba(255,160,0,0.5);
    }
    .headlight.on .headlight-body {
      background: linear-gradient(180deg, #2a2000 0%, #1a1400 100%);
    }
    .headlight.on .headlight-lens {
      background: radial-gradient(ellipse at 50% 30%, rgba(255,220,100,0.8) 0%, rgba(255,160,0,0.2) 70%, transparent 100%);
    }

    /* Pop-up animation: closed = tilted back, open = flat */
    .headlight.closed { transform: rotateX(85deg); transform-origin: bottom center; }
    .headlight.open   { transform: rotateX(0deg);  transform-origin: bottom center; }

    /* Light beam cone shown below headlight when ON */
    .beam {
      position: absolute;
      bottom: -80px;
      width: 0;
      height: 0;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .headlight.left  .beam {
      left: 50%;
      transform: translateX(-50%);
      border-left: 60px solid transparent;
      border-right: 60px solid transparent;
      border-top: 90px solid rgba(255,200,50,0.08);
    }
    .headlight.right .beam {
      right: 50%;
      transform: translateX(50%);
      border-left: 60px solid transparent;
      border-right: 60px solid transparent;
      border-top: 90px solid rgba(255,200,50,0.08);
    }
    .headlight.on .beam { opacity: 1; }

    /* Car body illustration */
    .car-body-svg { width: 320px; height: 120px; margin-top: -10px; }

    /* Subtle glow on the ground when lights are on */
    .ground-glow {
      position: absolute;
      bottom: 16px;
      width: 280px;
      height: 16px;
      background: radial-gradient(ellipse, rgba(255,184,0,0.0) 0%, transparent 70%);
      border-radius: 50%;
      transition: background 0.5s;
    }

    /* ============================================================
       CONTROL PANELS (2-column grid)
    ============================================================ */
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 20px;
      position: relative;
    }

    .panel-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    /* 2×2 grid for the main action buttons */
    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* Primary action button */
    .btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 12px 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .btn::before { content: ''; position: absolute; inset: 0; background: var(--amber); opacity: 0; transition: opacity 0.2s; }
    .btn:hover::before { opacity: 0.08; }

    /* Animation mode selector button */
    .mode-btn {
      width: 100%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 500;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 10px 14px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      text-align: left;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mode-btn:last-child { margin-bottom: 0; }

    /* Status dot inside each mode button */
    .mode-btn .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.2s;
    }
    .mode-btn:hover { color: var(--text); border-color: #333; }

    /* Active mode highlighted in amber */
    .mode-btn.active               { border-color: var(--amber); color: var(--amber); background: rgba(255,184,0,0.04); }
    .mode-btn.active .dot          { background: var(--amber); box-shadow: 0 0 8px var(--amber); }

    /* Settings sliders */
    .slider-wrap { margin-top: 8px; }

    .slider-label {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-value {
      font-family: 'Share Tech Mono', monospace;
      color: var(--amber);
      font-size: 13px;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 2px;
      background: var(--border);
      outline: none;
      border-radius: 1px;
      margin-bottom: 16px;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--amber);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255,184,0,0.5);
      border: 2px solid #0a0a0c;
    }

    /* ============================================================
       STATUS BAR (bottom of main container)
    ============================================================ */
    .status-bar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 24px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .status-item { display: flex; align-items: center; gap: 8px; }

    .status-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border);
    }
    .status-indicator.online {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: pulse 2s infinite;
    }

    .status-val { color: var(--text); }

    /* ============================================================
       INDIVIDUAL HEADLIGHT CONTROL
    ============================================================ */
    .individual-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .ind-col         { display: flex; flex-direction: column; gap: 6px; }
    .ind-label       { font-size: 10px; letter-spacing: 2px; color: var(--muted); text-align: center; margin-bottom: 4px; }

    /* Small toggle button for individual open / light controls */
    .btn-sm {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      text-align: center;
    }
    .btn-sm:hover            { color: var(--text); border-color: #333; }
    .btn-sm.active-green     { border-color: var(--green); color: var(--green); box-shadow: 0 0 10px rgba(57,255,106,0.15); }

    /* ============================================================
       DECORATIVE CORNER BRACKETS (panel accent)
    ============================================================ */
    .corner-tl, .corner-br { position: absolute; width: 12px; height: 12px; }
    .corner-tl { top: 0;    left: 0;   border-top:    2px solid var(--amber); border-left:   2px solid var(--amber); opacity: 0.5; }
    .corner-br { bottom: 0; right: 0;  border-bottom: 2px solid var(--amber); border-right:  2px solid var(--amber); opacity: 0.5; }

    /* ============================================================
       KEYFRAME ANIMATIONS
    ============================================================ */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    /* ============================================================
       SLEEPY EYES CONFIGURATION MODAL
    ============================================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }

    .modal {
      background: #0d0d10;
      border: 1px solid var(--amber);
      border-radius: 4px;
      width: 100%;
      max-width: 520px;
      margin: 16px;
      box-shadow: 0 0 60px rgba(255,184,0,0.15);
      overflow: hidden;
      transform: translateY(16px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-overlay.visible .modal { transform: translateY(0); }

    .modal-header {
      background: rgba(255,184,0,0.06);
      border-bottom: 1px solid rgba(255,184,0,0.2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title    { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 4px; color: var(--amber); }
    .modal-subtitle { font-family: 'Share Tech Mono', monospace; font-size: 9px; letter-spacing: 3px; color: var(--muted); margin-top: 2px; }

    .modal-close {
      background: transparent;
      border: 1px solid #333;
      color: var(--muted);
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      letter-spacing: 2px;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      text-transform: uppercase;
    }
    .modal-close:hover { border-color: var(--red); color: var(--red); }

    .modal-body { padding: 24px 20px; }

    /* Mini car preview inside the modal */
    .modal-preview {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      position: relative;
    }
    .modal-preview::before {
      content: 'PREVIEW';
      position: absolute;
      top: 8px;
      right: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 8px;
      letter-spacing: 3px;
      color: var(--muted);
    }

    .mini-car { position: relative; width: 220px; height: 100px; }

    .mini-hl {
      position: absolute;
      width: 52px;
      height: 34px;
      border: 1px solid #333;
      border-radius: 4px 4px 2px 2px;
      overflow: hidden;
      transform-origin: bottom center;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .mini-hl.left-hl  { left: 14px;  top: 28px; }
    .mini-hl.right-hl { right: 14px; top: 28px; }

    .mini-hl-body  { width: 100%; height: 100%; background: linear-gradient(180deg, #1a1400 0%, #111 100%); display: flex; align-items: center; justify-content: center; }
    .mini-hl-inner { width: 32px; height: 20px; border-radius: 3px 3px 1px 1px; background: #ffcc44; box-shadow: 0 0 12px rgba(255,200,60,0.8); }

    /* Dominant side selector */
    .dominant-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dom-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 12px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      text-align: center;
    }
    .dom-btn:hover        { border-color: #444; color: var(--text); }
    .dom-btn.active       { border-color: var(--amber); color: var(--amber); background: rgba(255,184,0,0.05); box-shadow: 0 0 16px rgba(255,184,0,0.15); }
    .dom-btn .dom-icon    { font-size: 18px; display: block; margin-bottom: 4px; }

    .modal-section-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    /* Eye opening angle sliders */
    .eye-slider-row  { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
    .eye-side-label  { font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--muted); width: 52px; flex-shrink: 0; }
    .eye-side-label span { display: block; font-size: 8px; color: #333; margin-top: 2px; }
    .eye-slider-wrap { flex: 1; }
    .eye-pct         { font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--amber); width: 38px; text-align: right; flex-shrink: 0; }

    /* Full-range slider for dominant side, half-range for non-dominant */
    input[type=range].eye-range { -webkit-appearance: none; width: 100%; height: 3px; border-radius: 2px; outline: none; }
    input[type=range].eye-range.full { background: var(--amber); }
    input[type=range].eye-range.half { background: rgba(255,184,0,0.5); }
    input[type=range].eye-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--amber);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255,184,0,0.6);
      border: 2px solid #0a0a0c;
    }

    /* Apply button at the bottom of the modal */
    .modal-apply {
      width: 100%;
      background: rgba(255,184,0,0.08);
      border: 1px solid var(--amber);
      color: var(--amber);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 3px;
      text-transform: uppercase;
      padding: 14px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      margin-top: 8px;
    }
    .modal-apply:hover { background: rgba(255,184,0,0.15); box-shadow: 0 0 20px rgba(255,184,0,0.2); }

    /* ============================================================
       RESPONSIVE — single column on small screens
    ============================================================ */
    @media (max-width: 600px) {
      .controls-grid      { grid-template-columns: 1fr; }
      .car-front          { width: 260px; }
      .car-body-svg       { width: 260px; }
      .headlight.left     { left: 14px; }
      .headlight.right    { right: 14px; }
    }
  </style>
</head>
<body>

  <!-- ============================================================
       PAGE HEADER
  ============================================================ -->
  <div class="header">
    <div class="header-top">
      <div class="logo-line"></div>
      <h1>MX-5</h1>
      <div class="logo-line right"></div>
    </div>
    <div class="subtitle">Pop-up Headlight Controller — NA Series</div>
  </div>

  <!-- ============================================================
       SERIAL / BLUETOOTH CONNECTION BAR
  ============================================================ -->
  <div class="bt-bar">
    <div class="bt-status-dot" id="bt-dot"></div>
    <div class="bt-status-text" id="bt-text">IKKE FORBUNDET</div>
    <span class="bt-device-name" id="bt-device-name" style="display:none"></span>
    <span class="bt-tx" id="bt-tx">TX &#9675;</span>
    <button class="bt-btn connect"    id="bt-connect-btn"    onclick="btConnect()">&#9685; Forbind</button>
    <button class="bt-btn disconnect" id="bt-disconnect-btn" onclick="btDisconnect()" style="display:none">&#x2715; Afbryd</button>
  </div>

  <!-- Warning shown when Web Serial API is not available (non-Chrome browsers) -->
  <div class="no-bt-warn" id="no-bt-warn"></div>

  <!-- ============================================================
       MAIN CONTENT AREA
  ============================================================ -->
  <div class="main-container">

    <!-- ---- Live car visualisation ---- -->
    <div class="car-viz">
      <div class="corner-tl"></div>
      <div class="corner-br"></div>

      <div class="car-front">

        <!-- Left headlight (starts closed / off) -->
        <div class="headlight left closed" id="hl-left">
          <div class="headlight-body">
            <div class="headlight-inner">
              <div class="headlight-lens"></div>
            </div>
          </div>
          <div class="beam"></div>
        </div>

        <!-- Right headlight (starts closed / off) -->
        <div class="headlight right closed" id="hl-right">
          <div class="headlight-body">
            <div class="headlight-inner">
              <div class="headlight-lens"></div>
            </div>
          </div>
          <div class="beam"></div>
        </div>

        <!-- SVG car body illustration -->
        <svg class="car-body-svg" viewBox="0 0 320 120" fill="none" xmlns="http://www.w3.org/2000/svg"
             style="position:absolute; top:60px; left:0">
          <path d="M20 100 L20 60 L50 40 L270 40 L300 60 L300 100 Z" fill="#111116" stroke="#1e1e2a" stroke-width="1.5"/>
          <!-- Windscreen frame -->
          <rect x="100" y="55" width="120" height="30" rx="3" fill="#0a0a0c" stroke="#222" stroke-width="1"/>
          <line x1="130" y1="55" x2="130" y2="85" stroke="#1a1a1a" stroke-width="1"/>
          <line x1="160" y1="55" x2="160" y2="85" stroke="#1a1a1a" stroke-width="1"/>
          <line x1="190" y1="55" x2="190" y2="85" stroke="#1a1a1a" stroke-width="1"/>
          <!-- Front bumper -->
          <rect x="50" y="90" width="220" height="8" rx="2" fill="#0d0d0d" stroke="#1a1a1a" stroke-width="1"/>
          <!-- Body crease line -->
          <line x1="50" y1="40" x2="270" y2="40" stroke="#1e1e2a" stroke-width="2"/>
          <!-- Mazda badge -->
          <circle cx="160" cy="70" r="10" fill="#111" stroke="#2a2a2a" stroke-width="1.5"/>
          <text x="160" y="74" text-anchor="middle" fill="#555" font-size="7" font-family="Rajdhani" font-weight="700">M</text>
          <!-- Wheel arches -->
          <rect x="60"  y="88" width="28" height="8" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
          <rect x="232" y="88" width="28" height="8" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
        </svg>
      </div>

      <!-- Ground glow underneath the car when lights are on -->
      <div class="ground-glow" id="ground-glow"></div>
    </div>

    <!-- ---- Control panels grid ---- -->
    <div class="controls-grid">

      <!-- Panel 1: Quick controls (both sides at once) + individual toggles -->
      <div class="panel">
        <div class="panel-label">Quick Control</div>

        <!-- Global open/close/on/off -->
        <div class="btn-grid">
          <button class="btn" onclick="setAll('open')">&#9650; Aaben alt</button>
          <button class="btn" onclick="setAll('close')">&#9660; Luk alt</button>
          <button class="btn" onclick="setAll('on')">&#9685; Lys TIL</button>
          <button class="btn" onclick="setAll('off')">&#9675; Lys FRA</button>
        </div>

        <!-- Per-side open & light toggles -->
        <div style="margin-top:14px">
          <div class="panel-label" style="margin-bottom:8px">Individuel kontrol</div>
          <div class="individual-btns">
            <div class="ind-col">
              <div class="ind-label">Venstre</div>
              <button class="btn-sm" id="ind-left-open"  onclick="toggleOpen('left')">&#9650; Aaben</button>
              <button class="btn-sm" id="ind-left-light" onclick="toggleLight('left')">&#9685; Lys</button>
            </div>
            <div class="ind-col">
              <div class="ind-label">Hoejre</div>
              <button class="btn-sm" id="ind-right-open"  onclick="toggleOpen('right')">&#9650; Aaben</button>
              <button class="btn-sm" id="ind-right-light" onclick="toggleLight('right')">&#9685; Lys</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel 2: Animation mode selector -->
      <div class="panel">
        <div class="panel-label">Animationsmode</div>
        <!-- Blink-Alt -->
        <button class="mode-btn" id="mode-blink-alt" onclick="setMode('blink-alt')">
          <span style="display:flex; align-items:center; width:100%">
            <span>&#9889; Alternerende blink</span>
            <span style="margin-left:auto; display:flex; align-items:center; gap:6px">
              <span class="dot"></span>
              <span onclick="event.stopPropagation(); openAnimModal('blink')"
                style="font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:2px; color:#555;
                       border:1px solid #2a2a2a; padding:3px 7px; border-radius:2px; cursor:pointer;"
                onmouseover="this.style.color='#ffb800'; this.style.borderColor='rgba(255,184,0,0.4)'"
                onmouseout="this.style.color='#555'; this.style.borderColor='#2a2a2a'">EDIT</span>
            </span>
          </span>
        </button>

        <!-- Wave -->
        <button class="mode-btn" id="mode-wave" onclick="setMode('wave')">
          <span style="display:flex; align-items:center; width:100%">
            <span>&#12316; Wave mode</span>
            <span style="margin-left:auto; display:flex; align-items:center; gap:6px">
              <span class="dot"></span>
              <span onclick="event.stopPropagation(); openAnimModal('wave')"
                style="font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:2px; color:#555;
                       border:1px solid #2a2a2a; padding:3px 7px; border-radius:2px; cursor:pointer;"
                onmouseover="this.style.color='#ffb800'; this.style.borderColor='rgba(255,184,0,0.4)'"
                onmouseout="this.style.color='#555'; this.style.borderColor='#2a2a2a'">EDIT</span>
            </span>
          </span>
        </button>

        <!-- Wink -->
        <button class="mode-btn" id="mode-wink" onclick="setMode('wink')">
          <span style="display:flex; align-items:center; width:100%">
            <span>&#128065; Blink mode</span>
            <span style="margin-left:auto; display:flex; align-items:center; gap:6px">
              <span class="dot"></span>
              <span onclick="event.stopPropagation(); openAnimModal('wink')"
                style="font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:2px; color:#555;
                       border:1px solid #2a2a2a; padding:3px 7px; border-radius:2px; cursor:pointer;"
                onmouseover="this.style.color='#ffb800'; this.style.borderColor='rgba(255,184,0,0.4)'"
                onmouseout="this.style.color='#555'; this.style.borderColor='#2a2a2a'">EDIT</span>
            </span>
          </span>
        </button>

        <!-- Sleepy Eyes: activates mode + has an EDIT shortcut for the config modal -->
        <button class="mode-btn" id="mode-sleepy" onclick="activateSleepyEyes()">
          <span style="display:flex; align-items:center; width:100%">
            <span>&#128564; Sleepy Eyes</span>
            <span style="margin-left:auto; display:flex; align-items:center; gap:6px">
              <span class="dot"></span>
              <!-- Separate click target so it opens the modal without also activating the mode -->
              <span
                onclick="event.stopPropagation(); openSleepyModal()"
                style="font-family:'Share Tech Mono',monospace; font-size:8px; letter-spacing:2px; color:#555;
                       border:1px solid #2a2a2a; padding:3px 7px; border-radius:2px; cursor:pointer;"
                onmouseover="this.style.color='#ffb800'; this.style.borderColor='rgba(255,184,0,0.4)'"
                onmouseout="this.style.color='#555'; this.style.borderColor='#2a2a2a'"
              >EDIT</span>
            </span>
          </span>
        </button>

        <button class="mode-btn" style="border-color:#333; color:#555" onclick="stopMode()">&#9632; Stop animation <div class="dot"></div></button>
      </div>

      <!-- Panel 3: Speed / easing sliders (spans full width) -->
      <div class="panel" style="grid-column: span 2">
        <div class="panel-label">Indstillinger</div>
        <div class="slider-wrap">
          <div class="slider-label"><span>Hastighed</span><span class="slider-value" id="speed-val">0.5s</span></div>
          <input type="range" min="100" max="2000" value="500" step="100" oninput="updateSpeed(this.value)">
          <div class="slider-label"><span>Easing</span><span class="slider-value" id="ease-val">0.5s</span></div>
          <input type="range" min="100" max="2000" value="500" step="100" oninput="updateEase(this.value)">
        </div>
      </div>
    </div>

    <!-- ---- Status bar ---- -->
    <div class="status-bar">
      <div class="status-item"><div class="status-indicator online"></div><span>System</span></div>
      <div class="status-item"><span>Venstre:</span><span class="status-val" id="stat-left">LUKKET &#8226; FRA</span></div>
      <div class="status-item"><span>Hoejre:</span><span  class="status-val" id="stat-right">LUKKET &#8226; FRA</span></div>
      <div class="status-item"><span>Mode:</span><span    class="status-val" id="stat-mode">STANDBY</span></div>
      <div class="status-item" style="margin-left:auto"><span style="font-size:10px; color:#333">MX-5 NA // CTRL v1.1</span></div>
    </div>

  </div><!-- /main-container -->

  <!-- ============================================================
       SLEEPY EYES CONFIGURATION MODAL
  ============================================================ -->
  <div class="modal-overlay" id="sleepy-modal">
    <div class="modal">

      <div class="modal-header">
        <div>
          <div class="modal-title">&#128564; Sleepy Eyes</div>
          <div class="modal-subtitle">Konfigurer aabningsvinkel og dominant side</div>
        </div>
        <button class="modal-close" onclick="closeSleepyModal()">&#x2715; Luk</button>
      </div>

      <div class="modal-body">

        <!-- Mini car preview that reacts to slider changes -->
        <div class="modal-preview">
          <div class="mini-car">
            <div class="mini-hl left-hl"  id="modal-hl-left">
              <div class="mini-hl-body"><div class="mini-hl-inner"></div></div>
            </div>
            <div class="mini-hl right-hl" id="modal-hl-right">
              <div class="mini-hl-body"><div class="mini-hl-inner"></div></div>
            </div>
            <!-- Scaled-down car body SVG -->
            <svg width="220" height="80" viewBox="0 0 220 80" style="position:absolute; top:40px; left:0" fill="none">
              <path d="M10 70 L10 42 L34 28 L186 28 L210 42 L210 70 Z" fill="#111116" stroke="#1e1e2a" stroke-width="1"/>
              <rect x="68" y="38" width="84" height="22" rx="2" fill="#0a0a0c" stroke="#222" stroke-width="1"/>
              <line x1="90"  y1="38" x2="90"  y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="110" y1="38" x2="110" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="130" y1="38" x2="130" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <rect x="34" y="62" width="152" height="6" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
              <circle cx="110" cy="50" r="7" fill="#111" stroke="#2a2a2a"/>
            </svg>
          </div>
        </div>

        <!-- Dominant side toggle -->
        <div class="modal-section-label">Dominant side</div>
        <div class="dominant-selector">
          <button class="dom-btn active" id="dom-left"  onclick="setDominant('left')"><span class="dom-icon">&#9664;</span>Venstre</button>
          <button class="dom-btn"        id="dom-right" onclick="setDominant('right')"><span class="dom-icon">&#9654;</span>Hoejre</button>
        </div>

        <!-- Per-eye opening angle sliders -->
        <div class="modal-section-label">Aabningsvinkel</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">VENSTRE<span id="lbl-left-dom">DOMINANT</span></div>
          <div class="eye-slider-wrap">
            <input type="range" class="eye-range full" id="slider-left-eye"
                   min="0" max="100" value="100"
                   oninput="updateEyeSlider('left', this.value)">
          </div>
          <div class="eye-pct" id="pct-left">100%</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOEJRE<span id="lbl-right-dom"></span></div>
          <div class="eye-slider-wrap">
            <input type="range" class="eye-range half" id="slider-right-eye"
                   min="0" max="100" value="20"
                   oninput="updateEyeSlider('right', this.value)">
          </div>
          <div class="eye-pct" id="pct-right">20%</div>
        </div>

        <button class="modal-apply" onclick="applySleepyAndClose()">&#8629; Anvend &amp; Aktiver</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       JAVASCRIPT
  ============================================================ -->
  <!-- ============================================================
       BLINK-ALT CONFIGURATION MODAL
  ============================================================ -->
  <div class="modal-overlay" id="blink-modal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">&#9889; Alternerende Blink</div>
          <div class="modal-subtitle">Konfigurer aabningsvinkel og antal cyklusser</div>
        </div>
        <button class="modal-close" onclick="closeAnimModal('blink')">&#x2715; Luk</button>
      </div>
      <div class="modal-body">

        <div class="modal-preview">
          <div class="mini-car">
            <div class="mini-hl left-hl"  id="blink-hl-left"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <div class="mini-hl right-hl" id="blink-hl-right"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <svg width="220" height="80" viewBox="0 0 220 80" style="position:absolute; top:40px; left:0" fill="none">
              <path d="M10 70 L10 42 L34 28 L186 28 L210 42 L210 70 Z" fill="#111116" stroke="#1e1e2a" stroke-width="1"/>
              <rect x="68" y="38" width="84" height="22" rx="2" fill="#0a0a0c" stroke="#222" stroke-width="1"/>
              <line x1="90"  y1="38" x2="90"  y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="110" y1="38" x2="110" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="130" y1="38" x2="130" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <rect x="34" y="62" width="152" height="6" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
              <circle cx="110" cy="50" r="7" fill="#111" stroke="#2a2a2a"/>
            </svg>
          </div>
        </div>

        <div class="modal-section-label">Aabningsvinkel</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">VENSTRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="blink-left-pct" min="10" max="100" value="100" oninput="updateAnimSlider('blink','leftPct',this.value)"></div>
          <div class="eye-pct" id="blink-left-val">100%</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOEJRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="blink-right-pct" min="10" max="100" value="100" oninput="updateAnimSlider('blink','rightPct',this.value)"></div>
          <div class="eye-pct" id="blink-right-val">100%</div>
        </div>

        <div class="modal-section-label">Antal cyklusser (L+R = 1 cyklus)</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">CYKL.</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="blink-cycles" min="1" max="10" value="2" oninput="updateAnimSlider('blink','cycles',this.value)"></div>
          <div class="eye-pct" id="blink-cycles-val">2x</div>
        </div>

        <div class="modal-section-label">Hastighed &amp; Easing</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOLD</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="blink-speed" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('blink','speed',this.value)"></div>
          <div class="eye-pct" id="blink-speed-val">0.5s</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">EASING</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="blink-ease" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('blink','ease',this.value)"></div>
          <div class="eye-pct" id="blink-ease-val">0.5s</div>
        </div>

        <button class="modal-apply" onclick="applyAnimModal('blink')">&#8629; Anvend &amp; Aktiver</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       WAVE CONFIGURATION MODAL
  ============================================================ -->
  <div class="modal-overlay" id="wave-modal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">&#12316; Wave Mode</div>
          <div class="modal-subtitle">Konfigurer aabningsvinkel og overlap</div>
        </div>
        <button class="modal-close" onclick="closeAnimModal('wave')">&#x2715; Luk</button>
      </div>
      <div class="modal-body">

        <div class="modal-preview">
          <div class="mini-car">
            <div class="mini-hl left-hl"  id="wave-hl-left"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <div class="mini-hl right-hl" id="wave-hl-right"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <svg width="220" height="80" viewBox="0 0 220 80" style="position:absolute; top:40px; left:0" fill="none">
              <path d="M10 70 L10 42 L34 28 L186 28 L210 42 L210 70 Z" fill="#111116" stroke="#1e1e2a" stroke-width="1"/>
              <rect x="68" y="38" width="84" height="22" rx="2" fill="#0a0a0c" stroke="#222" stroke-width="1"/>
              <line x1="90"  y1="38" x2="90"  y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="110" y1="38" x2="110" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="130" y1="38" x2="130" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <rect x="34" y="62" width="152" height="6" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
              <circle cx="110" cy="50" r="7" fill="#111" stroke="#2a2a2a"/>
            </svg>
          </div>
        </div>

        <div class="modal-section-label">Aabningsvinkel</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">VENSTRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wave-left-pct" min="10" max="100" value="100" oninput="updateAnimSlider('wave','leftPct',this.value)"></div>
          <div class="eye-pct" id="wave-left-val">100%</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOEJRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wave-right-pct" min="10" max="100" value="100" oninput="updateAnimSlider('wave','rightPct',this.value)"></div>
          <div class="eye-pct" id="wave-right-val">100%</div>
        </div>

        <div class="modal-section-label">Overlap — hvor tidligt hoejre side starter (%)</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">OVERLAP</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wave-overlap" min="0" max="90" value="33" oninput="updateAnimSlider('wave','overlap',this.value)"></div>
          <div class="eye-pct" id="wave-overlap-val">33%</div>
        </div>

        <div class="modal-section-label">Hastighed &amp; Easing</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOLD</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wave-speed" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('wave','speed',this.value)"></div>
          <div class="eye-pct" id="wave-speed-val">0.5s</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">EASING</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wave-ease" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('wave','ease',this.value)"></div>
          <div class="eye-pct" id="wave-ease-val">0.5s</div>
        </div>

        <button class="modal-apply" onclick="applyAnimModal('wave')">&#8629; Anvend &amp; Aktiver</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       WINK CONFIGURATION MODAL
  ============================================================ -->
  <div class="modal-overlay" id="wink-modal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">&#128065; Blink Mode</div>
          <div class="modal-subtitle">Konfigurer aabningsvinkel og tilfaeldig pause</div>
        </div>
        <button class="modal-close" onclick="closeAnimModal('wink')">&#x2715; Luk</button>
      </div>
      <div class="modal-body">

        <div class="modal-preview">
          <div class="mini-car">
            <div class="mini-hl left-hl"  id="wink-hl-left"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <div class="mini-hl right-hl" id="wink-hl-right"><div class="mini-hl-body"><div class="mini-hl-inner"></div></div></div>
            <svg width="220" height="80" viewBox="0 0 220 80" style="position:absolute; top:40px; left:0" fill="none">
              <path d="M10 70 L10 42 L34 28 L186 28 L210 42 L210 70 Z" fill="#111116" stroke="#1e1e2a" stroke-width="1"/>
              <rect x="68" y="38" width="84" height="22" rx="2" fill="#0a0a0c" stroke="#222" stroke-width="1"/>
              <line x1="90"  y1="38" x2="90"  y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="110" y1="38" x2="110" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <line x1="130" y1="38" x2="130" y2="60" stroke="#1a1a1a" stroke-width="1"/>
              <rect x="34" y="62" width="152" height="6" rx="1" fill="#0d0d0d" stroke="#1a1a1a"/>
              <circle cx="110" cy="50" r="7" fill="#111" stroke="#2a2a2a"/>
            </svg>
          </div>
        </div>

        <div class="modal-section-label">Aabningsvinkel</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">VENSTRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-left-pct" min="10" max="100" value="100" oninput="updateAnimSlider('wink','leftPct',this.value)"></div>
          <div class="eye-pct" id="wink-left-val">100%</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOEJRE</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-right-pct" min="10" max="100" value="100" oninput="updateAnimSlider('wink','rightPct',this.value)"></div>
          <div class="eye-pct" id="wink-right-val">100%</div>
        </div>

        <div class="modal-section-label">Tilfaeldig pause mellem blink</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">MIN SEK</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-min-pause" min="1" max="20" value="3" oninput="updateAnimSlider('wink','minPause',this.value)"></div>
          <div class="eye-pct" id="wink-min-val">3s</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">MAX SEK</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-max-pause" min="1" max="30" value="8" oninput="updateAnimSlider('wink','maxPause',this.value)"></div>
          <div class="eye-pct" id="wink-max-val">8s</div>
        </div>

        <div class="modal-section-label">Hastighed &amp; Easing</div>
        <div class="eye-slider-row">
          <div class="eye-side-label">HOLD</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-speed" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('wink','speed',this.value)"></div>
          <div class="eye-pct" id="wink-speed-val">0.5s</div>
        </div>
        <div class="eye-slider-row">
          <div class="eye-side-label">EASING</div>
          <div class="eye-slider-wrap"><input type="range" class="eye-range full" id="wink-ease" min="100" max="2000" value="500" step="100" oninput="updateAnimSlider('wink','ease',this.value)"></div>
          <div class="eye-pct" id="wink-ease-val">0.5s</div>
        </div>

        <button class="modal-apply" onclick="applyAnimModal('wink')">&#8629; Anvend &amp; Aktiver</button>
      </div>
    </div>
  </div>

  <script>

    // ============================================================
    // GLOBAL STATE
    // Tracks the logical state of both headlights and the current
    // animation mode. applyState() reads this and updates the DOM.
    // ============================================================
    const state = {
      left:      { open: false, on: false },
      right:     { open: false, on: false },
      mode:      null,    // active animation mode identifier
      speed:     500,     // hold time in ms (open duration)
      ease:      500,     // transition time in ms (open/close speed)
      interval:  null,    // setInterval handle for looping modes
      _winkStop: null     // stop-flag callback for async animation loops
    };

    // Sleepy Eyes configuration (persists across modal open/close)
    const sleepyConfig = {
      dominant: 'left',  // which side opens to 100%
      leftPct:  100,     // opening percentage for left  (0–100)
      rightPct: 20       // opening percentage for right (0–100)
    };

    // Blink-Alt configuration
    const blinkConfig = {
      leftPct:  100,   // how far left headlight opens (0–100)
      rightPct: 100,   // how far right headlight opens (0–100)
      cycles:   2,     // number of L+R cycles before auto-stop
      speed:    500,   // hold time in ms (how long it stays open)
      ease:     500    // transition time in ms (open/close speed)
    };

    // Wave configuration
    const waveConfig = {
      leftPct:  100,   // how far left headlight opens (0–100)
      rightPct: 100,   // how far right headlight opens (0–100)
      overlap:  33,    // overlap % — how early the second side starts (0–90)
      speed:    500,   // hold time in ms
      ease:     500    // transition time in ms
    };

    // Wink configuration
    const winkConfig = {
      leftPct:   100,  // how far left headlight opens (0–100)
      rightPct:  100,  // how far right headlight opens (0–100)
      minPause:  3,    // minimum random pause between winks (seconds)
      maxPause:  8,    // maximum random pause between winks (seconds)
      speed:     500,  // hold time in ms
      ease:      500   // transition time in ms
    };

    // ============================================================
    // WEB SERIAL API — USB connection to the ESP32 (CP2102)
    // ============================================================
    let serialPort     = null;   // active SerialPort object
    let serialWriter   = null;   // WritableStreamDefaultWriter
    let serialReader   = null;   // ReadableStreamDefaultReader
    let btConnected    = false;  // true when port is open and ready
    let readLoopActive = false;  // controls the read-loop while-loop
    let txFlashTimeout = null;   // debounce handle for TX indicator

    // Check if the browser supports Web Serial (Chrome / Edge only)
    const hasSerial = 'serial' in navigator;

    /**
     * setBtUI — updates all connection-related UI elements to reflect
     * the current connection state.
     * @param {string} s - 'connected' | 'connecting' | 'error' | 'idle'
     */
    function setBtUI(s) {
      const dot  = document.getElementById('bt-dot');
      const text = document.getElementById('bt-text');
      const conn = document.getElementById('bt-connect-btn');
      const disc = document.getElementById('bt-disconnect-btn');
      const name = document.getElementById('bt-device-name');

      dot.className = 'bt-status-dot ' + s;

      if (s === 'connected') {
        text.textContent  = 'FORBUNDET';
        text.className    = 'bt-status-text connected';
        conn.style.display = 'none';
        disc.style.display = '';
        name.style.display = '';
        name.textContent  = 'MX5-CTRL';
      } else if (s === 'connecting') {
        text.textContent  = 'FORBINDER...';
        text.className    = 'bt-status-text';
        conn.style.display = 'none';
        disc.style.display = 'none';
      } else if (s === 'error') {
        text.textContent  = 'FORBINDELSESFEJL';
        text.className    = 'bt-status-text error';
        conn.style.display = '';
        disc.style.display = 'none';
        name.style.display = 'none';
      } else {
        // idle / disconnected
        text.textContent  = 'IKKE FORBUNDET';
        text.className    = 'bt-status-text';
        conn.style.display = '';
        disc.style.display = 'none';
        name.style.display = 'none';
      }
    }

    /**
     * btConnect — opens the Web Serial port selector, then connects
     * at 115200 baud and sends a PING to verify the device.
     */
    async function btConnect() {
      if (!hasSerial) {
        const w = document.getElementById('no-bt-warn');
        w.style.display = 'block';
        w.textContent   = '⚠ Web Serial API requires Chrome/Edge. Connect the ESP32 via USB and click Connect.';
        return;
      }
      try {
        setBtUI('connecting');
        serialPort   = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 115200 });
        serialWriter = serialPort.writable.getWriter();
        btConnected  = true;
        setBtUI('connected');
        startReadLoop();
        await sendCmd('PING');
      } catch (e) {
        // NotFoundError = user cancelled the port picker dialog → go back to idle
        setBtUI(e.name === 'NotFoundError' ? 'idle' : 'error');
      }
    }

    /**
     * btDisconnect — cleanly tears down readers, writers and the port.
     */
    async function btDisconnect() {
      readLoopActive = false;
      btConnected    = false;
      try { if (serialWriter) { serialWriter.releaseLock(); serialWriter = null; } } catch(e) {}
      try { if (serialReader) { serialReader.cancel();      serialReader = null; } } catch(e) {}
      try { if (serialPort)   { await serialPort.close();   serialPort   = null; } } catch(e) {}
      setBtUI('idle');
      document.getElementById('stat-mode').textContent = 'AFBRUDT';
    }

    /**
     * sendCmd — encodes and sends a newline-terminated command string
     * to the ESP32, and flashes the TX indicator.
     * @param {string} cmd - command string, e.g. 'L:OPEN', 'MODE:WAVE:500'
     */
    async function sendCmd(cmd) {
      if (!btConnected || !serialWriter) return;
      try {
        await serialWriter.write(new TextEncoder().encode(cmd + '\n'));
        flashTX();
      } catch(e) {}
    }

    /**
     * flashTX — briefly highlights the TX indicator to show data was sent.
     */
    function flashTX() {
      const el = document.getElementById('bt-tx');
      el.textContent = 'TX ◉';
      el.classList.add('flash');
      clearTimeout(txFlashTimeout);
      txFlashTimeout = setTimeout(() => {
        el.textContent = 'TX ○';
        el.classList.remove('flash');
      }, 120);
    }

    /**
     * startReadLoop — continuously reads lines from the serial port
     * and handles device responses (e.g. PONG after a PING).
     */
    async function startReadLoop() {
      readLoopActive = true;
      try {
        serialReader = serialPort.readable.getReader();
        let buf = '';
        while (readLoopActive) {
          const { value, done } = await serialReader.read();
          if (done) break;
          buf += new TextDecoder().decode(value);
          // Process all complete lines in the buffer
          let nl;
          while ((nl = buf.indexOf('\n')) !== -1) {
            const line = buf.substring(0, nl).trim();
            buf = buf.substring(nl + 1);
            if (line === 'PONG') {
              document.getElementById('bt-text').textContent = 'FORBUNDET — MX5-CTRL ONLINE';
            }
          }
        }
      } catch(e) {
        if (readLoopActive) setBtUI('error');
      } finally {
        try { serialReader.releaseLock(); } catch(e) {}
      }
    }

    // ============================================================
    // UTILITY HELPERS
    // ============================================================

    /** Returns a Promise that resolves after `ms` milliseconds. */
    const delay = ms => new Promise(r => setTimeout(r, ms));

    /**
     * pctToAngle — converts an opening percentage (0–100) to a
     * CSS rotateX angle. 0% → 85° (fully closed), 100% → 0° (fully open).
     * @param {number} pct
     * @returns {number} degrees
     */
    const pctToAngle = pct => 85 - (pct / 100) * 85;

    /**
     * syncGlow — lightweight update used by animation loops.
     * Only updates the ground glow and status bar — does NOT touch
     * headlight transforms or classes (the loop manages those directly).
     */
    function syncGlow() {
      const anyOn = state.left.on || state.right.on;
      document.getElementById("ground-glow").style.background = anyOn
        ? "radial-gradient(ellipse, rgba(255,184,0,0.12) 0%, transparent 70%)"
        : "radial-gradient(ellipse, rgba(255,184,0,0.0)  0%, transparent 70%)";
      document.getElementById("stat-left").textContent  = (state.left.open  ? "AABEN" : "LUKKET") + " \u2022 " + (state.left.on  ? "TIL" : "FRA");
      document.getElementById("stat-right").textContent = (state.right.open ? "AABEN" : "LUKKET") + " \u2022 " + (state.right.on ? "TIL" : "FRA");
      // Sync glow class on headlights for the on-state amber colour
      ["left", "right"].forEach(s => {
        const el = document.getElementById("hl-" + s);
        if (state[s].on) el.classList.add("on"); else el.classList.remove("on");
      });
    }

    // ============================================================
    // STATE APPLICATION — syncs the DOM to the current state object
    // ============================================================

    /**
     * applyState — the single source of truth renderer.
     * Reads `state` and `sleepyConfig` and updates:
     *   - headlight CSS classes / transforms
     *   - individual toggle button labels and colours
     *   - ground glow intensity
     *   - status bar text
     */
    function applyState() {
      ['left', 'right'].forEach(side => {
        const el = document.getElementById('hl-' + side);

        // Use per-animation ease if a named mode is active, else fall back to global state.ease
        const activeEase = state.mode === 'blink-alt' ? blinkConfig.ease
                         : state.mode === 'wave'      ? waveConfig.ease
                         : state.mode === 'wink'      ? winkConfig.ease
                         : state.ease;
        el.style.transition = `transform ${activeEase / 1000}s cubic-bezier(0.34,1.56,0.64,1)`;

        if (state.mode === 'sleepy') {
          // Sleepy Eyes: lights always on, rotated to the configured angle
          const pct = side === 'left' ? sleepyConfig.leftPct : sleepyConfig.rightPct;
          el.className          = 'headlight ' + side + ' on';
          el.style.transform    = `rotateX(${pctToAngle(pct)}deg)`;
          el.style.transformOrigin = 'bottom center';
        } else if (state.mode === 'blink-alt' || state.mode === 'wave' || state.mode === 'wink') {
          // Animation modes: loop controls el.style.transform directly — don't clear it.
          // Still apply closed/open class so CSS fallback angle is correct before loop fires.
          el.className = 'headlight ' + side;
          if (state[side].open) el.classList.add('open'); else el.classList.add('closed');
          if (state[side].on)   el.classList.add('on');
          el.style.transformOrigin = 'bottom center';
        } else {
          // Normal open/close + on/off state via CSS classes
          el.style.transform = '';
          el.className       = 'headlight ' + side;
          if (state[side].open) el.classList.add('open');   else el.classList.add('closed');
          if (state[side].on)   el.classList.add('on');
        }

        // Update individual control button labels
        const ob = document.getElementById('ind-' + side + '-open');
        const lb = document.getElementById('ind-' + side + '-light');
        if (ob) {
          ob.className  = 'btn-sm' + (state[side].open ? ' active-green' : '');
          ob.textContent = state[side].open ? '▼ Luk' : '▲ Åben';
        }
        if (lb) {
          lb.className = 'btn-sm' + (state[side].on ? ' active-green' : '');
        }
      });

      // Ground glow appears whenever any light is on
      const anyOn = state.left.on || state.right.on || state.mode === 'sleepy';
      document.getElementById('ground-glow').style.background = anyOn
        ? 'radial-gradient(ellipse, rgba(255,184,0,0.12) 0%, transparent 70%)'
        : 'radial-gradient(ellipse, rgba(255,184,0,0.0)  0%, transparent 70%)';

      // Helper to format per-side status text
      const sideStatus = side => {
        if (state.mode === 'sleepy') {
          const pct = side === 'left' ? sleepyConfig.leftPct : sleepyConfig.rightPct;
          return `${pct}% AABEN • TIL`;
        }
        return (state[side].open ? 'AABEN' : 'LUKKET') + ' • ' + (state[side].on ? 'TIL' : 'FRA');
      };
      document.getElementById('stat-left').textContent  = sideStatus('left');
      document.getElementById('stat-right').textContent = sideStatus('right');
    }

    // ============================================================
    // QUICK CONTROL — affects both headlights simultaneously
    // ============================================================

    /**
     * setAll — performs a bulk action on both headlights.
     * @param {string} action - 'open' | 'close' | 'on' | 'off'
     */
    function setAll(action) {
      stopAnimation(); // stop loop only — preserve current light state
      if (action === 'open')  { state.left.open = true;  state.right.open = true; }
      if (action === 'close') { state.left.open = false; state.right.open = false; }
      if (action === 'on')    { state.left.on   = true;  state.right.on   = true; }
      if (action === 'off')   { state.left.on   = false; state.right.on   = false; }
      applyState();
      if (action === 'open')  { sendCmd('L:OPEN');  sendCmd('R:OPEN'); }
      if (action === 'close') { sendCmd('L:CLOSE'); sendCmd('R:CLOSE'); }
      if (action === 'on')    { sendCmd('L:ON');    sendCmd('R:ON'); }
      if (action === 'off')   { sendCmd('L:OFF');   sendCmd('R:OFF'); }
    }

    /**
     * toggleOpen — flips the open/closed state for one headlight.
     * @param {string} side - 'left' | 'right'
     */
    function toggleOpen(side) {
      stopAnimation();
      state[side].open = !state[side].open;
      applyState();
      sendCmd(`${side === 'left' ? 'L' : 'R'}:${state[side].open ? 'OPEN' : 'CLOSE'}`);
    }

    /**
     * toggleLight — flips the on/off state for one headlight.
     * @param {string} side - 'left' | 'right'
     */
    function toggleLight(side) {
      stopAnimation();
      state[side].on = !state[side].on;
      applyState();
      sendCmd(`${side === 'left' ? 'L' : 'R'}:${state[side].on ? 'ON' : 'OFF'}`);
    }

    // ============================================================
    // STOP ANIMATIONS
    // ============================================================

    /**
     * stopAnimation — stopper kun loops/intervaller og rydder mode-UI.
     * Rører IKKE lygte-state. Bruges af quick controls.
     */
    function stopAnimation() {
      if (state._winkStop) { state._winkStop(); state._winkStop = null; }
      if (state.interval)  { clearInterval(state.interval); state.interval = null; }

      state.mode = null;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('stat-mode').textContent = btConnected ? 'FORBUNDET' : 'STANDBY';

      ['left', 'right'].forEach(side => {
        document.getElementById('hl-' + side).style.transform = '';
      });

      sendCmd('MODE:STOP');
    }

    /**
     * stopMode — fuld nulstilling: stopper animationer OG lukker/slukker
     * begge lygter. Bruges af "Stop animation"-knappen og mode-skift.
     */
    function stopMode() {
      stopAnimation();

      state.left.open  = false; state.left.on  = false;
      state.right.open = false; state.right.on = false;
      applyState();

      sendCmd('L:CLOSE'); sendCmd('R:CLOSE');
      sendCmd('L:OFF');   sendCmd('R:OFF');
    }

    // ============================================================
    // SLEEPY EYES MODE — partially open headlights
    // ============================================================

    /**
     * activateSleepyEyes — stops any running mode, then applies the
     * sleepy-eyes state using the current sleepyConfig values.
     */
    function activateSleepyEyes() {
      stopMode();
      state.mode = 'sleepy';
      document.getElementById('mode-sleepy').classList.add('active');
      document.getElementById('stat-mode').textContent = 'SLEEPY EYES';
      applyState();
      sendCmd(`MODE:SLEEPY:${sleepyConfig.leftPct}:${sleepyConfig.rightPct}`);
    }

    // ============================================================
    // ANIMATION MODES — async loops controlling headlight sequences
    // ============================================================

    /**
     * setMode — activates a named animation mode.
     * Each mode is an async loop controlled by a stop-flag.
     * @param {string} mode - 'blink-alt' | 'wave' | 'wink'
     */
    function setMode(mode) {
      stopMode();
      state.mode = mode;
      const btn = document.getElementById('mode-' + mode);
      if (btn) btn.classList.add('active');
      document.getElementById('stat-mode').textContent = mode.toUpperCase();

      // Notify the ESP32 of the new mode + per-animation speed setting
      const modeMap = { 'blink-alt': 'BLINK_ALT', 'wave': 'WAVE', 'wink': 'WINK' };
      const modeSpeed = mode === 'blink-alt' ? blinkConfig.speed
                      : mode === 'wave'      ? waveConfig.speed
                      : mode === 'wink'      ? winkConfig.speed
                      : state.speed;
      if (modeMap[mode]) sendCmd(`MODE:${modeMap[mode]}:${modeSpeed}`);

      // ----------------------------------------------------------------
      // BLINK-ALT
      // Strict alternating sequence: L fully opens → closes, then R opens
      // → closes, repeated twice (2 full L+R cycles), then auto-stops.
      // The next side begins opening when the current is 2/3 through closing
      // (overlapDelay) to create a smooth handoff.
      // ----------------------------------------------------------------
      if (mode === 'blink-alt') {
        state.left.open  = false; state.left.on  = false;
        state.right.open = false; state.right.on = false;
        ['left', 'right'].forEach(s => { document.getElementById('hl-' + s).style.transform = ''; });
        applyState();

        let blinkRunning = true;
        state._winkStop  = () => { blinkRunning = false; };

        const overlapDelay = Math.round(blinkConfig.ease * 2 / 3);

        // Helper: set one headlight to its configured open percentage
        function setBlinkOpen(side, isOpen) {
          const pct = side === 'left' ? blinkConfig.leftPct : blinkConfig.rightPct;
          const el  = document.getElementById('hl-' + side);
          el.style.transition = `transform ${blinkConfig.ease / 1000}s cubic-bezier(0.34,1.56,0.64,1)`;
          if (isOpen) {
            state[side].open = true; state[side].on = true;
            el.style.transform       = `rotateX(${pctToAngle(pct)}deg)`;
            el.style.transformOrigin = 'bottom center';
          } else {
            state[side].open = false; state[side].on = false;
            el.style.transform       = `rotateX(85deg)`;
            el.style.transformOrigin = 'bottom center';
          }
          syncGlow();
        }

        async function runBlinkAlt() {
          // Build sequence: each cycle is L then R, repeated blinkConfig.cycles times
          const pair = ['left', 'right'];
          const sequence = [];
          for (let c = 0; c < blinkConfig.cycles; c++) sequence.push(...pair);

          for (let i = 0; i < sequence.length; i++) {
            if (!blinkRunning || state.mode !== 'blink-alt') return;
            const current = sequence[i];
            const next    = sequence[i + 1];

            if (i === 0) setBlinkOpen(current, true);

            await delay(blinkConfig.ease + blinkConfig.speed);
            if (!blinkRunning || state.mode !== 'blink-alt') return;

            setBlinkOpen(current, false);

            if (next) {
              await delay(overlapDelay);
              if (!blinkRunning || state.mode !== 'blink-alt') return;
              setBlinkOpen(next, true);
              await delay(blinkConfig.ease - overlapDelay);
              if (!blinkRunning || state.mode !== 'blink-alt') return;
            } else {
              await delay(blinkConfig.ease);
              if (!blinkRunning || state.mode !== 'blink-alt') return;
            }
          }

          if (blinkRunning) {
            state.mode      = null;
            state._winkStop = null;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('stat-mode').textContent = btConnected ? 'FORBUNDET' : 'STANDBY';
            ['left','right'].forEach(s => { document.getElementById('hl-'+s).style.transform = ''; });
            state.left.open  = false; state.left.on  = false;
            state.right.open = false; state.right.on = false;
            applyState();
            sendCmd('L:CLOSE'); sendCmd('R:CLOSE');
            sendCmd('L:OFF');   sendCmd('R:OFF');
          }
        }
        runBlinkAlt();
        state.interval = null;

      // ----------------------------------------------------------------
      // WAVE
      // Continuous overlapping open/close loop.
      // Right joins the opening 1/3 into left's movement, creating a
      // smooth rolling wave effect. Loops indefinitely until stopped.
      // ----------------------------------------------------------------
      } else if (mode === 'wave') {
        state.left.open  = false; state.left.on  = false;
        state.right.open = false; state.right.on = false;
        ['left', 'right'].forEach(s => { document.getElementById('hl-' + s).style.transform = ''; });
        applyState();

        let waveRunning = true;
        state._winkStop = () => { waveRunning = false; };

        // Helper: set one headlight to its configured wave open percentage
        function setWaveOpen(side, isOpen) {
          const pct = side === 'left' ? waveConfig.leftPct : waveConfig.rightPct;
          const el  = document.getElementById('hl-' + side);
          el.style.transition = `transform ${waveConfig.ease / 1000}s cubic-bezier(0.34,1.56,0.64,1)`;
          if (isOpen) {
            state[side].open = true; state[side].on = true;
            el.style.transform       = `rotateX(${pctToAngle(pct)}deg)`;
            el.style.transformOrigin = 'bottom center';
          } else {
            state[side].open = false; state[side].on = false;
            el.style.transform       = `rotateX(85deg)`;
            el.style.transformOrigin = 'bottom center';
          }
          syncGlow();
        }

        async function runWave() {
          while (waveRunning && state.mode === 'wave') {
            // overlapDelay is derived from the waveConfig overlap % of the ease time
            const overlapDelay = Math.round(waveConfig.ease * waveConfig.overlap / 100);

            setWaveOpen('left', true);
            await delay(overlapDelay);
            if (!waveRunning || state.mode !== 'wave') return;
            setWaveOpen('right', true);

            await delay(waveConfig.ease - overlapDelay + waveConfig.speed);
            if (!waveRunning || state.mode !== 'wave') return;

            setWaveOpen('left', false);
            await delay(overlapDelay);
            if (!waveRunning || state.mode !== 'wave') return;
            setWaveOpen('right', false);

            await delay(waveConfig.ease - overlapDelay + waveConfig.speed);
            if (!waveRunning || state.mode !== 'wave') return;
          }
        }
        runWave();
        state.interval = null;

      // ----------------------------------------------------------------
      // WINK
      // Same overlapping motion as Wave, but with a long randomised pause
      // between each cycle (minimum 5 s + up to 4× the speed setting).
      // This makes the "blink" feel spontaneous and unpredictable.
      // ----------------------------------------------------------------
      } else if (mode === 'wink') {
        state.left.open  = false; state.left.on  = false;
        state.right.open = false; state.right.on = false;
        ['left', 'right'].forEach(s => { document.getElementById('hl-' + s).style.transform = ''; });
        applyState();

        let winkRunning = true;
        state._winkStop = () => { winkRunning = false; };

        const overlapDelay = Math.round(winkConfig.ease / 3);

        // Helper: set one headlight to its configured wink open percentage
        function setWinkOpen(side, isOpen) {
          const pct = side === 'left' ? winkConfig.leftPct : winkConfig.rightPct;
          const el  = document.getElementById('hl-' + side);
          el.style.transition = `transform ${winkConfig.ease / 1000}s cubic-bezier(0.34,1.56,0.64,1)`;
          if (isOpen) {
            state[side].open = true; state[side].on = true;
            el.style.transform       = `rotateX(${pctToAngle(pct)}deg)`;
            el.style.transformOrigin = 'bottom center';
          } else {
            state[side].open = false; state[side].on = false;
            el.style.transform       = `rotateX(85deg)`;
            el.style.transformOrigin = 'bottom center';
          }
          syncGlow();
        }

        async function runWink() {
          while (winkRunning && state.mode === 'wink') {
            if (!winkRunning || state.mode !== 'wink') return;

            setWinkOpen('left', true);
            await delay(overlapDelay);
            if (!winkRunning || state.mode !== 'wink') return;
            setWinkOpen('right', true);

            await delay(winkConfig.ease - overlapDelay + winkConfig.speed);
            if (!winkRunning || state.mode !== 'wink') return;

            setWinkOpen('left', false);
            await delay(overlapDelay);
            if (!winkRunning || state.mode !== 'wink') return;
            setWinkOpen('right', false);

            await delay(winkConfig.ease - overlapDelay);
            if (!winkRunning || state.mode !== 'wink') return;

            // Random pause between winkConfig.minPause and winkConfig.maxPause seconds
            const pauseMs = winkConfig.minPause * 1000
                          + Math.random() * (winkConfig.maxPause - winkConfig.minPause) * 1000;
            await delay(pauseMs);
          }
        }
        runWink();
        state.interval = null;
      }
    }

    // ============================================================
    // SETTINGS — speed and ease sliders
    // ============================================================

    /**
     * updateSpeed — updates state.speed and restarts any active looping mode
     * so the new speed takes effect immediately.
     * @param {number|string} val - slider value in milliseconds
     */
    function updateSpeed(val) {
      state.speed = parseInt(val);
      document.getElementById('speed-val').textContent = (val / 1000).toFixed(1) + 's';
      // Restart looping modes so they pick up the new speed
      if (state.mode && state.mode !== 'sleepy' && state.mode !== 'wink') {
        const m = state.mode;
        setMode(m);
      }
    }

    /**
     * updateEase — updates state.ease (CSS transition duration) and
     * re-applies state so the change is immediately visible.
     * @param {number|string} val - slider value in milliseconds
     */
    function updateEase(val) {
      state.ease = parseInt(val);
      document.getElementById('ease-val').textContent = (val / 1000).toFixed(1) + 's';
      applyState();
    }

    // ============================================================
    // SLEEPY EYES MODAL
    // ============================================================

    /** openSleepyModal — syncs sliders to current config then shows the modal. */
    function openSleepyModal() {
      syncModalSliders();
      updateModalPreview();
      document.getElementById('sleepy-modal').classList.add('visible');
    }

    /** closeSleepyModal — hides the modal without applying changes. */
    function closeSleepyModal() {
      document.getElementById('sleepy-modal').classList.remove('visible');
    }

    // Close modal when clicking outside the modal card
    document.getElementById('sleepy-modal').addEventListener('click', function(e) {
      if (e.target === this) closeSleepyModal();
    });

    /** syncModalSliders — writes current sleepyConfig values into the modal UI. */
    function syncModalSliders() {
      document.getElementById('slider-left-eye').value  = sleepyConfig.leftPct;
      document.getElementById('slider-right-eye').value = sleepyConfig.rightPct;
      document.getElementById('pct-left').textContent   = sleepyConfig.leftPct  + '%';
      document.getElementById('pct-right').textContent  = sleepyConfig.rightPct + '%';
      highlightDominantBtn();
    }

    /**
     * setDominant — locks the chosen side to 100% and ensures the other
     * side is not also at 100% (resets it to 20% if needed).
     * @param {string} side - 'left' | 'right'
     */
    function setDominant(side) {
      sleepyConfig.dominant = side;
      if (side === 'left') {
        sleepyConfig.leftPct = 100;
        if (sleepyConfig.rightPct >= 100) sleepyConfig.rightPct = 20;
      } else {
        sleepyConfig.rightPct = 100;
        if (sleepyConfig.leftPct  >= 100) sleepyConfig.leftPct  = 20;
      }
      syncModalSliders();
      updateModalPreview();
      // Live-update if the sleepy mode is already active
      if (state.mode === 'sleepy') {
        applyState();
        sendCmd(`MODE:SLEEPY:${sleepyConfig.leftPct}:${sleepyConfig.rightPct}`);
      }
    }

    /**
     * highlightDominantBtn — updates the dominant-side button styling and
     * slider track colours to reflect which side is currently dominant.
     */
    function highlightDominantBtn() {
      document.getElementById('dom-left').className  = 'dom-btn' + (sleepyConfig.dominant === 'left'  ? ' active' : '');
      document.getElementById('dom-right').className = 'dom-btn' + (sleepyConfig.dominant === 'right' ? ' active' : '');
      document.getElementById('lbl-left-dom').textContent  = sleepyConfig.dominant === 'left'  ? 'DOMINANT' : '';
      document.getElementById('lbl-right-dom').textContent = sleepyConfig.dominant === 'right' ? 'DOMINANT' : '';
      // Dominant slider gets the full amber track; non-dominant gets a dimmer track
      document.getElementById('slider-left-eye').className  = 'eye-range ' + (sleepyConfig.dominant === 'left'  ? 'full' : 'half');
      document.getElementById('slider-right-eye').className = 'eye-range ' + (sleepyConfig.dominant === 'right' ? 'full' : 'half');
    }

    /**
     * updateEyeSlider — called when either eye-angle slider changes.
     * Updates the config and live-previews the result.
     * @param {string} side - 'left' | 'right'
     * @param {number|string} val - 0–100 percentage
     */
    function updateEyeSlider(side, val) {
      val = parseInt(val);
      if (side === 'left') {
        sleepyConfig.leftPct = val;
        document.getElementById('pct-left').textContent  = val + '%';
      } else {
        sleepyConfig.rightPct = val;
        document.getElementById('pct-right').textContent = val + '%';
      }
      updateModalPreview();
      // If sleepy mode is already active, push the change to the car instantly
      if (state.mode === 'sleepy') {
        applyState();
        sendCmd(`MODE:SLEEPY:${sleepyConfig.leftPct}:${sleepyConfig.rightPct}`);
      }
    }

    /**
     * updateModalPreview — rotates the mini headlights in the modal
     * preview to match the current slider values.
     */
    function updateModalPreview() {
      ['left', 'right'].forEach(side => {
        const el  = document.getElementById('modal-hl-' + side);
        const pct = side === 'left' ? sleepyConfig.leftPct : sleepyConfig.rightPct;
        el.style.transform       = `rotateX(${pctToAngle(pct)}deg)`;
        el.style.transformOrigin = 'bottom center';
        el.style.transition      = 'transform 0.3s ease';
      });
    }

    /**
     * applySleepyAndClose — closes the modal and immediately activates
     * the sleepy-eyes mode with the configured values.
     */
    function applySleepyAndClose() {
      closeSleepyModal();
      activateSleepyEyes();
    }

    // ============================================================
    // INITIALISATION
    // ============================================================

    // Show a warning if the browser doesn't support Web Serial
    if (!hasSerial) {
      const w = document.getElementById('no-bt-warn');
      w.style.display = 'block';
      w.textContent   = '⚠ Web Serial API requires Chrome/Edge. Connect the ESP32 via USB (CP2102) and click Connect.';
    }

    // Render the initial (all-off) state
    applyState();
    updateModalPreview();
    // Sync animation modal previews to their default config values
    ['blink', 'wave', 'wink'].forEach(updateAnimPreview);

    // ============================================================
    // ANIMATION CONFIG MODALS (blink, wave, wink)
    // ============================================================

    /**
     * openAnimModal — syncs sliders to current config values then shows
     * the modal for the given animation type.
     * @param {string} type - 'blink' | 'wave' | 'wink'
     */
    function openAnimModal(type) {
      syncAnimSliders(type);
      updateAnimPreview(type);
      document.getElementById(type + '-modal').classList.add('visible');
    }

    /** closeAnimModal — hides the modal without applying changes. */
    function closeAnimModal(type) {
      document.getElementById(type + '-modal').classList.remove('visible');
    }

    // Close modals when clicking the backdrop
    ['blink', 'wave', 'wink'].forEach(type => {
      document.getElementById(type + '-modal').addEventListener('click', function(e) {
        if (e.target === this) closeAnimModal(type);
      });
    });

    /**
     * syncAnimSliders — writes the current config values into the modal
     * slider inputs and display labels.
     * @param {string} type - 'blink' | 'wave' | 'wink'
     */
    function syncAnimSliders(type) {
      if (type === 'blink') {
        document.getElementById('blink-left-pct').value   = blinkConfig.leftPct;
        document.getElementById('blink-right-pct').value  = blinkConfig.rightPct;
        document.getElementById('blink-cycles').value     = blinkConfig.cycles;
        document.getElementById('blink-speed').value      = blinkConfig.speed;
        document.getElementById('blink-ease').value       = blinkConfig.ease;
        document.getElementById('blink-left-val').textContent   = blinkConfig.leftPct  + '%';
        document.getElementById('blink-right-val').textContent  = blinkConfig.rightPct + '%';
        document.getElementById('blink-cycles-val').textContent = blinkConfig.cycles   + 'x';
        document.getElementById('blink-speed-val').textContent  = (blinkConfig.speed / 1000).toFixed(1) + 's';
        document.getElementById('blink-ease-val').textContent   = (blinkConfig.ease  / 1000).toFixed(1) + 's';
      } else if (type === 'wave') {
        document.getElementById('wave-left-pct').value    = waveConfig.leftPct;
        document.getElementById('wave-right-pct').value   = waveConfig.rightPct;
        document.getElementById('wave-overlap').value     = waveConfig.overlap;
        document.getElementById('wave-speed').value       = waveConfig.speed;
        document.getElementById('wave-ease').value        = waveConfig.ease;
        document.getElementById('wave-left-val').textContent    = waveConfig.leftPct  + '%';
        document.getElementById('wave-right-val').textContent   = waveConfig.rightPct + '%';
        document.getElementById('wave-overlap-val').textContent = waveConfig.overlap  + '%';
        document.getElementById('wave-speed-val').textContent   = (waveConfig.speed  / 1000).toFixed(1) + 's';
        document.getElementById('wave-ease-val').textContent    = (waveConfig.ease   / 1000).toFixed(1) + 's';
      } else if (type === 'wink') {
        document.getElementById('wink-left-pct').value    = winkConfig.leftPct;
        document.getElementById('wink-right-pct').value   = winkConfig.rightPct;
        document.getElementById('wink-min-pause').value   = winkConfig.minPause;
        document.getElementById('wink-max-pause').value   = winkConfig.maxPause;
        document.getElementById('wink-speed').value       = winkConfig.speed;
        document.getElementById('wink-ease').value        = winkConfig.ease;
        document.getElementById('wink-left-val').textContent  = winkConfig.leftPct  + '%';
        document.getElementById('wink-right-val').textContent = winkConfig.rightPct + '%';
        document.getElementById('wink-min-val').textContent   = winkConfig.minPause + 's';
        document.getElementById('wink-max-val').textContent   = winkConfig.maxPause + 's';
        document.getElementById('wink-speed-val').textContent = (winkConfig.speed   / 1000).toFixed(1) + 's';
        document.getElementById('wink-ease-val').textContent  = (winkConfig.ease    / 1000).toFixed(1) + 's';
      }
    }

    /**
     * updateAnimSlider — called on every slider input event.
     * Updates the matching config object, refreshes the display label,
     * and updates the preview headlights.
     * @param {string} type  - 'blink' | 'wave' | 'wink'
     * @param {string} param - config property name
     * @param {string} raw   - raw slider string value
     */
    function updateAnimSlider(type, param, raw) {
      const val = parseInt(raw);

      // Clamp wink: minPause must always be <= maxPause
      if (type === 'wink' && param === 'minPause') {
        winkConfig.minPause = Math.min(val, winkConfig.maxPause);
        document.getElementById('wink-min-val').textContent = winkConfig.minPause + 's';
        document.getElementById('wink-min-pause').value = winkConfig.minPause;
      } else if (type === 'wink' && param === 'maxPause') {
        winkConfig.maxPause = Math.max(val, winkConfig.minPause);
        document.getElementById('wink-max-val').textContent = winkConfig.maxPause + 's';
        document.getElementById('wink-max-pause').value = winkConfig.maxPause;
      } else {
        // Generic update
        const cfg = type === 'blink' ? blinkConfig : type === 'wave' ? waveConfig : winkConfig;
        cfg[param] = val;

        // Update the matching display label
        const labelMap = {
          leftPct:  [type + '-left-val',     v => v + '%'],
          rightPct: [type + '-right-val',    v => v + '%'],
          cycles:   ['blink-cycles-val',     v => v + 'x'],
          overlap:  ['wave-overlap-val',     v => v + '%'],
          minPause: ['wink-min-val',         v => v + 's'],
          maxPause: ['wink-max-val',         v => v + 's'],
          speed:    [type + '-speed-val',    v => (v / 1000).toFixed(1) + 's'],
          ease:     [type + '-ease-val',     v => (v / 1000).toFixed(1) + 's'],
        };
        if (labelMap[param]) {
          const [id, fmt] = labelMap[param];
          document.getElementById(id).textContent = fmt(val);
        }
      }

      updateAnimPreview(type);

      // Live-update if this animation is currently running
      if (state.mode === type || (type === 'blink' && state.mode === 'blink-alt')) {
        setMode(state.mode);
      }
    }

    /**
     * updateAnimPreview — rotates the mini headlights in the modal to
     * show the configured open angle for each side.
     * @param {string} type - 'blink' | 'wave' | 'wink'
     */
    function updateAnimPreview(type) {
      const cfg = type === 'blink' ? blinkConfig : type === 'wave' ? waveConfig : winkConfig;
      ['left', 'right'].forEach(side => {
        const el  = document.getElementById(type + '-hl-' + side);
        const pct = side === 'left' ? cfg.leftPct : cfg.rightPct;
        el.style.transform       = `rotateX(${pctToAngle(pct)}deg)`;
        el.style.transformOrigin = 'bottom center';
        el.style.transition      = 'transform 0.3s ease';
      });
    }

    /**
     * applyAnimModal — closes the modal and activates the animation
     * with the newly configured values.
     * @param {string} type - 'blink' | 'wave' | 'wink'
     */
    function applyAnimModal(type) {
      closeAnimModal(type);
      setMode(type === 'blink' ? 'blink-alt' : type);
    }


  </script>

</body>
</html>
